<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOURNEY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Cormorant+Garamond:wght@400;500;600&display=swap');

        :root {
            --void: #0a0a0f;
            --earth-deep: #1a1612;
            --text-dim: #5a5550;
            --text-mid: #8a8580;
            --text-bright: #d4cdc0;
            --accent-gold: #d4a574;
            --accent-warm: #c07050;
            --card-bg: #1e1c1a;
            --card-border: rgba(212, 165, 116, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(180deg, var(--void) 0%, var(--earth-deep) 100%);
            color: var(--text-bright);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            position: relative;
        }

        /* Subtle texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }

        /* ========== START OVERLAY (Card Style) ========== */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, var(--void) 0%, var(--earth-deep) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            perspective: 1200px;
        }

        #start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease 0.5s;
        }

        .start-card {
            width: 280px;
            height: 400px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            cursor: pointer;
        }

        .start-card.flipped {
            transform: rotateY(180deg);
        }

        .start-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--card-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .start-card-front {
            background: linear-gradient(160deg, var(--card-bg) 0%, #141210 50%, #1a1816 100%);
        }

        .start-card-front h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            font-weight: 400;
            letter-spacing: 0.4rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(212, 165, 116, 0.3);
        }

        .start-card-front p {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-style: italic;
            letter-spacing: 0.1rem;
            margin-bottom: 2rem;
        }

        .start-card-front .begin-text {
            font-size: 0.75rem;
            color: var(--text-mid);
            letter-spacing: 0.15rem;
            text-transform: lowercase;
            animation: gentlePulse 3s ease-in-out infinite;
        }

        .start-card-back {
            background: linear-gradient(160deg, #1a1816 0%, var(--card-bg) 50%, #141210 100%);
            transform: rotateY(180deg);
            padding: 1.5rem;
        }

        /* Small wizard on card back */
        .mini-wizard-container {
            margin-bottom: 1rem;
        }

        .mini-wizard-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            width: 120px;
            height: 120px;
        }

        .mini-led {
            aspect-ratio: 1;
            border-radius: 50%;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .mini-led.on {
            background: var(--accent-gold);
            box-shadow: 0 0 4px var(--accent-gold);
        }

        .start-card-back .welcome-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: var(--text-bright);
            text-align: center;
            line-height: 1.8;
            font-style: italic;
        }

        .start-card-back .continue-btn {
            margin-top: 1.5rem;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 0.6rem 1.5rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.15rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .start-card-back .continue-btn:hover {
            background: var(--accent-gold);
            color: var(--void);
        }

        @keyframes gentlePulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* ========== HEADER ========== */
        header {
            text-align: center;
            padding: 1rem 0;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 400;
            letter-spacing: 0.4rem;
            color: var(--text-bright);
            opacity: 0.9;
        }

        .subtitle {
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.2rem;
            font-style: italic;
            margin-top: 0.3rem;
        }

        /* ========== WIZARD DISPLAY ========== */
        .wizard-section {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            width: 100%;
            max-width: 600px;
        }

        .wizard-container {
            flex-shrink: 0;
        }

        .wizard-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(212, 165, 116, 0.2);
        }

        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .led.on {
            background: var(--led-color, var(--accent-gold));
            box-shadow: 0 0 6px var(--led-color, var(--accent-gold));
        }

        .wizard-speech {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-left: 2px solid var(--accent-gold);
            padding: 1rem 1.25rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            border-radius: 0 6px 6px 0;
        }

        .wizard-speech p {
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-bright);
            font-style: italic;
        }

        /* ========== CARDS ========== */
        .cards-section {
            width: 100%;
            max-width: 700px;
        }

        .cards-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            perspective: 1200px;
            min-height: 260px;
        }

        .story-card {
            width: 160px;
            height: 240px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.4s cubic-bezier(0.25, 0.1, 0.25, 1),
                        opacity 1.2s ease;
            cursor: pointer;
            opacity: 0;
            transform: translateY(30px);
        }

        .story-card.visible {
            opacity: 1;
            transform: translateY(0);
            transition: transform 1.2s cubic-bezier(0.22, 0.61, 0.36, 1),
                        opacity 1s ease;
        }

        .story-card.flipped {
            transform: rotateY(180deg);
        }

        .story-card.visible.flipped {
            transform: translateY(0) rotateY(180deg);
        }

        .story-card.selected {
            transform: rotateY(180deg) scale(1.05);
            z-index: 10;
            transition: transform 1.4s cubic-bezier(0.25, 0.1, 0.25, 1),
                        opacity 1.2s ease;
        }

        .story-card.faded {
            opacity: 0.15;
            pointer-events: none;
            transition: transform 1.4s cubic-bezier(0.25, 0.1, 0.25, 1),
                        opacity 1s ease 0.3s;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            border: 2px solid var(--card-border);
            overflow: hidden;
        }

        .card-front {
            background: linear-gradient(160deg, var(--card-bg) 0%, #141210 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-front::before {
            content: '?';
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            color: var(--accent-gold);
            opacity: 0.4;
        }

        .card-back {
            background: linear-gradient(160deg, #fffef7 0%, #f8f4e6 100%);
            transform: rotateY(180deg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            color: #3b2f2f;
        }

        .card-type {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.15rem;
            color: #7b4e2d;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #5d4e37;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }

        .card-text {
            font-size: 0.75rem;
            line-height: 1.6;
            color: #6b5845;
            flex: 1;
        }

        .card-tone {
            font-size: 0.55rem;
            text-transform: lowercase;
            color: #a08060;
            font-style: italic;
            margin-top: auto;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* Card type colors */
        .story-card[data-role="character"] .card-type { color: #6b8e7d; }
        .story-card[data-role="place"] .card-type { color: #7d8e6b; }
        .story-card[data-role="action"] .card-type { color: #8e6b6b; }
        .story-card[data-role="object"] .card-type { color: #8e7d6b; }
        .story-card[data-role="tone"] .card-type { color: #6b7d8e; }
        .story-card[data-role="problem"] .card-type { color: #8e6b7d; }
        .story-card[data-role="resolution"] .card-type { color: #7d8e8e; }

        /* ========== STORY LOG ========== */
        .story-section {
            width: 100%;
            max-width: 600px;
        }

        .story-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .story-header h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            font-weight: 400;
            color: var(--text-mid);
            letter-spacing: 0.15rem;
        }

        .story-count {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .story-log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 165, 116, 0.15);
            border-radius: 6px;
            padding: 1.25rem;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
        }

        .story-log::-webkit-scrollbar {
            width: 4px;
        }

        .story-log::-webkit-scrollbar-track {
            background: transparent;
        }

        .story-log::-webkit-scrollbar-thumb {
            background: var(--text-dim);
            border-radius: 2px;
        }

        .story-entry {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(212, 165, 116, 0.1);
            animation: fadeIn 1s ease;
        }

        .story-entry:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .story-entry-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.95rem;
            color: var(--accent-gold);
            margin-bottom: 0.25rem;
        }

        .story-entry-text {
            font-size: 0.8rem;
            color: var(--text-mid);
            line-height: 1.5;
        }

        .story-empty {
            color: var(--text-dim);
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
            padding: 2rem 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== CONTROLS ========== */
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .control-btn {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 0.5rem 1.25rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .control-btn.tell-story {
            opacity: 0.4;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .control-btn.tell-story.ready {
            opacity: 1;
            pointer-events: auto;
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            animation: gentleGlow 2s ease-in-out infinite;
        }

        .control-btn.tell-story.ready:hover {
            background: var(--accent-gold);
            color: var(--void);
            animation: none;
        }

        @keyframes gentleGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(212, 165, 116, 0.3); }
            50% { box-shadow: 0 0 15px rgba(212, 165, 116, 0.5); }
        }

        /* ========== END OVERLAY ========== */
        #end-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 2s ease, background 3s ease;
            perspective: 1200px;
        }

        #end-overlay.active {
            opacity: 1;
            pointer-events: auto;
            background: rgba(10, 10, 15, 0.85);
        }

        .end-card {
            width: 320px;
            height: 520px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.8s cubic-bezier(0.25, 0.1, 0.25, 1),
                        opacity 1.5s ease;
            opacity: 0;
            transform: translateY(40px) scale(0.95);
        }

        .end-card.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .end-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--card-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),
                        0 0 40px rgba(212, 165, 116, 0.15);
            background: linear-gradient(160deg, var(--card-bg) 0%, #141210 50%, #1a1816 100%);
            padding: 2rem;
        }

        .end-card .end-wizard-container {
            margin-bottom: 1.5rem;
        }

        .end-wizard-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            width: 100px;
            height: 100px;
        }

        .end-led {
            aspect-ratio: 1;
            border-radius: 50%;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .end-led.on {
            background: var(--accent-gold);
            box-shadow: 0 0 4px var(--accent-gold);
        }

        .end-card h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6rem;
            font-weight: 400;
            letter-spacing: 0.3rem;
            color: var(--accent-gold);
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .end-card .story-summary {
            font-size: 0.8rem;
            color: var(--text-mid);
            text-align: center;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .end-card .story-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.85rem;
            color: var(--text-bright);
            text-align: center;
            line-height: 1.8;
            font-style: italic;
            margin-bottom: 1rem;
            min-height: 60px;
            max-height: 120px;
            padding: 0 0.5rem;
            opacity: 0;
            transition: opacity 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .end-card .story-text.visible {
            opacity: 1;
        }

        .end-card .story-text.fade-out {
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .end-card .story-text::-webkit-scrollbar {
            width: 3px;
        }

        .end-card .story-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .end-card .story-text::-webkit-scrollbar-thumb {
            background: var(--text-dim);
            border-radius: 2px;
        }

        .end-card .farewell-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            color: var(--text-bright);
            text-align: center;
            line-height: 1.8;
            font-style: italic;
            margin-bottom: 1rem;
            opacity: 0;
            transition: opacity 1.5s ease;
        }

        .end-card .farewell-text.visible {
            opacity: 1;
        }

        .end-card .new-story-btn {
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 0.75rem 2rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            letter-spacing: 0.15rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .end-card .new-story-btn.visible {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease, background 0.3s ease, color 0.3s ease;
        }

        .end-card .new-story-btn:hover {
            background: var(--accent-gold);
            color: var(--void);
        }

        /* Screen dim effect for main content */
        .container.dimmed {
            opacity: 0.3;
            transition: opacity 2s ease;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            .wizard-section {
                flex-direction: column;
                align-items: center;
            }

            .wizard-speech {
                border-left: none;
                border-top: 2px solid var(--accent-gold);
                border-radius: 0 0 6px 6px;
                width: 100%;
            }

            .cards-container {
                flex-wrap: wrap;
            }

            .story-card {
                width: 140px;
                height: 210px;
            }
        }
    </style>
</head>
<body>
    <!-- Start Overlay (Card Style) -->
    <div id="start-overlay">
        <div class="start-card" id="start-card" onclick="flipStartCard()">
            <div class="start-card-face start-card-front">
                <h2>Journey</h2>
                <p>a story unfolds</p>
                <span class="begin-text">tap to begin</span>
            </div>
            <div class="start-card-face start-card-back">
                <div class="mini-wizard-container">
                    <div class="mini-wizard-grid" id="mini-wizard-grid"></div>
                </div>
                <p class="welcome-text">
                    "Hello, traveler.<br>
                    I am here to witness<br>
                    the story you will tell."
                </p>
                <button class="continue-btn" onclick="startGame(event)">enter</button>
            </div>
        </div>
    </div>

    <!-- End Overlay -->
    <div id="end-overlay">
        <div class="end-card" id="end-card">
            <div class="end-card-face">
                <div class="end-wizard-container">
                    <div class="end-wizard-grid" id="end-wizard-grid"></div>
                </div>
                <h2>Story Complete</h2>
                <p class="story-summary" id="end-story-summary"></p>
                <p class="story-text" id="end-story-text"></p>
                <p class="farewell-text" id="farewell-text">
                    "Thank you for sharing<br>
                    this story with me."
                </p>
                <button class="new-story-btn" id="new-story-btn" onclick="startNewStoryFromEnd()">new story?</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Journey</h1>
            <div class="subtitle">build a story, one card at a time</div>
        </header>

        <!-- Wizard Display -->
        <section class="wizard-section">
            <div class="wizard-container">
                <div class="wizard-grid" id="wizard-grid"></div>
            </div>
            <div class="wizard-speech">
                <p id="wizard-text">Choose a card to begin your story.</p>
            </div>
        </section>

        <!-- Cards -->
        <section class="cards-section">
            <div class="cards-container" id="cards-container"></div>
        </section>

        <!-- Story Log -->
        <section class="story-section">
            <div class="story-header">
                <h3>Your Story</h3>
                <span class="story-count" id="story-count">0 cards</span>
            </div>
            <div class="story-log" id="story-log">
                <p class="story-empty">Your story will unfold here...</p>
            </div>
        </section>

        <!-- Controls -->
        <div class="controls">
            <button class="control-btn" id="tts-toggle" onclick="toggleTTS()">voice: on</button>
            <button class="control-btn tell-story" id="tell-story-btn" onclick="tellStory()">tell story</button>
            <button class="control-btn" onclick="newStory()">new story</button>
        </div>
    </div>

    <audio id="music" loop>
        <source src="music/jaunt.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ============================================
        // CARD DATA
        // ============================================
        const CARDS = [
            // CHARACTER cards
            { id: 1, role: 'character', title: 'The Wanderer', text: 'A figure appears on the path, their cloak heavy with distance traveled.', beat: 'someone set out without knowing where the path would lead', tone: 'calm', theme: 'journey', weight: 'light' },
            { id: 2, role: 'character', title: 'The Child', text: 'Small hands reach out, curious eyes reflecting starlight.', beat: 'a young heart found wonder in what others had forgotten to see', tone: 'warm', theme: 'home', weight: 'light' },
            { id: 3, role: 'character', title: 'The Keeper', text: 'Someone who has tended this place longer than memory serves.', beat: 'they were watched over by one who remembered the old ways', tone: 'calm', theme: 'nature', weight: 'heavy' },
            { id: 4, role: 'character', title: 'The Echo', text: 'A presence felt more than seen, like a voice from long ago.', beat: 'something from before made itself known without speaking', tone: 'strange', theme: 'mystery', weight: 'heavy' },
            { id: 5, role: 'character', title: 'The Companion', text: 'A creature of few words but steady presence walks alongside.', beat: 'the journey was no longer carried alone', tone: 'warm', theme: 'journey', weight: 'light' },
            { id: 6, role: 'character', title: 'The Builder', text: 'Hands that shape the world, one careful piece at a time.', beat: 'someone was found who could make broken things whole again', tone: 'hopeful', theme: 'machine', weight: 'light' },

            // PLACE cards
            { id: 7, role: 'place', title: 'The Threshold', text: 'A doorway stands where none should be, patient and waiting.', beat: 'they reached a place where turning back felt heavier than going forward', tone: 'strange', theme: 'mystery', weight: 'heavy' },
            { id: 8, role: 'place', title: 'The Garden', text: 'Things grow here that have forgotten how to be still.', beat: 'a living place was discovered where things grew without being asked', tone: 'calm', theme: 'nature', weight: 'light' },
            { id: 9, role: 'place', title: 'The Hearth', text: 'Warmth radiates from stones that remember every story told beside them.', beat: 'warmth was found in a place that remembered kindness', tone: 'warm', theme: 'home', weight: 'light' },
            { id: 10, role: 'place', title: 'The Ruins', text: 'What was built here served a purpose now lost to knowing.', beat: 'they walked through what remained of something once important', tone: 'tense', theme: 'machine', weight: 'heavy' },
            { id: 11, role: 'place', title: 'The Crossroads', text: 'Every direction holds a different question.', beat: 'a choice had to be made between paths that could not all be walked', tone: 'hopeful', theme: 'journey', weight: 'light' },
            { id: 12, role: 'place', title: 'The Deep Woods', text: 'Shadows stack upon shadows, yet something glows softly ahead.', beat: 'the way grew dark, but a faint light waited in the distance', tone: 'strange', theme: 'nature', weight: 'heavy' },

            // ACTION cards
            { id: 13, role: 'action', title: 'A Gift Given', text: 'Something precious changes hands without expectation of return.', beat: 'something precious was offered freely, without asking for return', tone: 'warm', theme: 'home', weight: 'light' },
            { id: 14, role: 'action', title: 'A Door Opens', text: 'What was sealed now yields, revealing what lies beyond.', beat: 'what had been closed finally opened', tone: 'hopeful', theme: 'mystery', weight: 'light' },
            { id: 15, role: 'action', title: 'A Memory Surfaces', text: 'The past arrives unbidden, clear as morning water.', beat: 'the past arrived unbidden, clear as morning water', tone: 'tense', theme: 'journey', weight: 'heavy' },
            { id: 16, role: 'action', title: 'Something Breaks', text: 'In the breaking, a new shape becomes possible.', beat: 'something had to break before a new shape became possible', tone: 'tense', theme: 'machine', weight: 'heavy' },
            { id: 17, role: 'action', title: 'Roots Take Hold', text: 'What was temporary becomes permanent, for better or worse.', beat: 'what seemed temporary began to feel like it might stay', tone: 'calm', theme: 'nature', weight: 'light' },
            { id: 18, role: 'action', title: 'A Promise Made', text: 'Words spoken that bind the future to this moment.', beat: 'words were spoken that bound the future to that moment', tone: 'hopeful', theme: 'home', weight: 'heavy' },

            // OBJECT cards
            { id: 19, role: 'object', title: 'The Lantern', text: 'It holds light that does not flicker, even in wind.', beat: 'a small light was carried, not to banish the dark, but to soften it', tone: 'hopeful', theme: 'journey', weight: 'light' },
            { id: 20, role: 'object', title: 'The Key', text: 'What it opens has yet to be found.', beat: 'an answer was discovered before the question was fully understood', tone: 'strange', theme: 'mystery', weight: 'light' },
            { id: 21, role: 'object', title: 'The Letter', text: 'Words written long ago, still waiting to be read.', beat: 'words from someone far away finally reached their destination', tone: 'tense', theme: 'home', weight: 'heavy' },
            { id: 22, role: 'object', title: 'The Seed', text: 'Small enough to forget, patient enough to wait centuries.', beat: 'something small was planted that would outlast the one who planted it', tone: 'calm', theme: 'nature', weight: 'light' },
            { id: 23, role: 'object', title: 'The Compass', text: 'It points to something other than north.', beat: 'a guide was found that pointed toward something other than direction', tone: 'strange', theme: 'machine', weight: 'light' },
            { id: 24, role: 'object', title: 'The Stone', text: 'Worn smooth by countless hands seeking comfort.', beat: 'comfort was found in something simple and worn by time', tone: 'warm', theme: 'journey', weight: 'light' },

            // TONE cards
            { id: 25, role: 'tone', title: 'A Hush Falls', text: 'The world grows quiet, listening for what comes next.', beat: 'everything grew quiet, as if the world itself was listening', tone: 'calm', theme: 'mystery', weight: 'light' },
            { id: 26, role: 'tone', title: 'Dawn Approaches', text: 'The sky remembers color after forgetting it all night.', beat: 'the sky remembered color after forgetting it all night', tone: 'hopeful', theme: 'nature', weight: 'light' },
            { id: 27, role: 'tone', title: 'Shadows Lengthen', text: 'The familiar becomes strange as light retreats.', beat: 'things became difficult for a while, and nothing could be hurried', tone: 'tense', theme: 'mystery', weight: 'heavy' },
            { id: 28, role: 'tone', title: 'Rain Begins', text: 'The world softens, edges blurring into gentleness.', beat: 'the world softened, and edges blurred into gentleness', tone: 'calm', theme: 'nature', weight: 'light' },
            { id: 29, role: 'tone', title: 'A Fire Crackles', text: 'Warmth blooms in the dark, drawing all closer.', beat: 'warmth bloomed in the dark, drawing all things closer', tone: 'warm', theme: 'home', weight: 'light' },
            { id: 30, role: 'tone', title: 'Wind Stirs', text: 'Something is changing, carried on the moving air.', beat: 'something shifted, carried on the moving air', tone: 'strange', theme: 'journey', weight: 'light' },

            // PROBLEM cards (available during complication phase)
            { id: 31, role: 'problem', title: 'The Path Fades', text: 'What was clear becomes uncertain. The way forward must be found anew.', beat: 'the path they had followed disappeared, and they stood uncertain', tone: 'tense', theme: 'journey', weight: 'heavy' },
            { id: 32, role: 'problem', title: 'Something Lost', text: 'What was held dear slips away, leaving an absence that echoes.', beat: 'something precious was lost, and its absence weighed heavily', tone: 'tense', theme: 'home', weight: 'heavy' },
            { id: 33, role: 'problem', title: 'The Storm Gathers', text: 'Dark clouds mass on the horizon. Shelter must be sought or made.', beat: 'a storm gathered, and there was no clear place to shelter', tone: 'tense', theme: 'nature', weight: 'heavy' },
            { id: 34, role: 'problem', title: 'A Trust Broken', text: 'What was believed proves false. The foundation cracks.', beat: 'trust was broken, and nothing seemed certain anymore', tone: 'tense', theme: 'mystery', weight: 'heavy' },
            { id: 35, role: 'problem', title: 'The Machine Fails', text: 'What once worked falls silent. Old ways must serve where new ones cannot.', beat: 'what they relied upon failed, and they had to find another way', tone: 'tense', theme: 'machine', weight: 'heavy' },
            { id: 36, role: 'problem', title: 'A Shadow Falls', text: 'Something dims the light. Not evil, but difficult. A weight that must be carried.', beat: 'a shadow fell across the journey, and the way grew harder', tone: 'tense', theme: 'mystery', weight: 'heavy' },

            // RESOLUTION cards (available during closing phase)
            { id: 37, role: 'resolution', title: 'Understanding Comes', text: 'What was confused becomes clear. The pieces finally fit.', beat: 'understanding came at last, quiet and complete', tone: 'calm', theme: 'mystery', weight: 'light' },
            { id: 38, role: 'resolution', title: 'Home Is Found', text: 'Not a return, but a discovery. The heart knows where it belongs.', beat: 'home was found, not where expected, but where it was needed', tone: 'warm', theme: 'home', weight: 'light' },
            { id: 39, role: 'resolution', title: 'The Wound Heals', text: 'Time and care close what was broken. A scar remains, but it no longer hurts.', beat: 'what was wounded began to heal, slowly but surely', tone: 'hopeful', theme: 'nature', weight: 'light' },
            { id: 40, role: 'resolution', title: 'Peace Settles', text: 'The struggle ends not in victory, but in acceptance. That is enough.', beat: 'peace settled over everything, and the struggle ended', tone: 'calm', theme: 'journey', weight: 'light' },
            { id: 41, role: 'resolution', title: 'A New Beginning', text: 'From the ending, something fresh emerges. The cycle turns.', beat: 'from the ending, a new beginning quietly emerged', tone: 'hopeful', theme: 'nature', weight: 'light' },
            { id: 42, role: 'resolution', title: 'The Circle Closes', text: 'What started long ago finds its completion. The story knows its shape.', beat: 'the circle closed, and the story found its shape', tone: 'calm', theme: 'journey', weight: 'light' }
        ];

        // ============================================
        // WIZARD DIALOGUE
        // ============================================
        const DIALOGUE = {
            start: [
                "Choose a card to begin your story.",
                "Three paths await. Which calls to you?",
                "The story begins with a single choice."
            ],
            // Reactions by tone
            calm: [
                "The story breathes softly now.",
                "A gentle thread weaves through.",
                "Peace settles into the narrative."
            ],
            warm: [
                "Warmth enters the telling.",
                "Something kind has arrived.",
                "The story grows gentler."
            ],
            hopeful: [
                "Light finds its way in.",
                "The path ahead brightens.",
                "Hope threads through your words."
            ],
            tense: [
                "The story tightens here.",
                "Something shifts beneath.",
                "Weight gathers in the telling."
            ],
            strange: [
                "The familiar bends.",
                "Mystery seeps through.",
                "The story reaches somewhere new."
            ],
            // Reactions by pattern
            themeRepeat: [
                "A thread returns.",
                "The story remembers itself.",
                "Echoes form patterns."
            ],
            toneShift: [
                "The color changes.",
                "The story turns a corner.",
                "A new feeling arrives."
            ],
            roleBalance: [
                "The story finds balance.",
                "All pieces have their place.",
                "The weave grows richer."
            ],
            // Phase-specific dialogue
            phaseMiddle: [
                "The world opens before you.",
                "The journey continues.",
                "More threads to weave."
            ],
            phaseComplication: [
                "The story deepens now. Challenges may appear.",
                "We enter uncertain ground. Choose carefully.",
                "The path grows harder. What will you face?"
            ],
            phaseClosing: [
                "The ending draws near. How will it resolve?",
                "The story seeks its shape. Resolution awaits.",
                "All threads must find their end. Choose wisely."
            ],
            // Problem card reactions
            problem: [
                "A challenge enters the tale.",
                "Difficulty finds its way in.",
                "The story must face this now."
            ],
            // Resolution card reactions
            resolution: [
                "The story finds its peace.",
                "A fitting end takes shape.",
                "Resolution settles gently."
            ]
        };

        // ============================================
        // GAME STATE
        // ============================================
        const game = {
            story: [],
            currentCards: [],
            cardIndex: 0,
            ttsEnabled: true,
            lastPhase: 'opening',
            coherence: {
                themes: {},
                tones: {},
                roles: {},
                lastTone: null
            }
        };

        // ============================================
        // WIZARD LED PATTERNS (10x10)
        // ============================================
        const WIZARD_FACES = {
            calm: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,1,1,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ],
                color: '#d4a574'
            },
            curious: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,1,1,1,1,0,0,0,
                    0,0,1,0,0,0,0,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ],
                color: '#e8c080'
            },
            pleased: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,1,0,0,0,0,0,0,1,0,
                    0,0,1,0,0,0,0,1,0,0,
                    0,0,0,1,1,1,1,0,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ],
                color: '#f0d090'
            },
            unsettled: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,1,1,1,1,0,0,0,
                    0,0,1,0,0,0,0,1,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ],
                color: '#b08050'
            },
            thinking: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,1,1,0,0,0,0,
                    0,0,0,0,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ],
                color: '#c09060'
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        const music = document.getElementById('music');
        let leds = [];
        let miniLeds = [];
        let endLeds = [];
        let audioContext = null;

        function init() {
            // Create main wizard grid
            const wizardGrid = document.getElementById('wizard-grid');
            for (let i = 0; i < 100; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                wizardGrid.appendChild(led);
                leds.push(led);
            }

            // Create mini wizard grid for start card
            const miniGrid = document.getElementById('mini-wizard-grid');
            for (let i = 0; i < 100; i++) {
                const led = document.createElement('div');
                led.className = 'mini-led';
                miniGrid.appendChild(led);
                miniLeds.push(led);
            }

            // Create end wizard grid
            const endGrid = document.getElementById('end-wizard-grid');
            for (let i = 0; i < 100; i++) {
                const led = document.createElement('div');
                led.className = 'end-led';
                endGrid.appendChild(led);
                endLeds.push(led);
            }

            setWizardMood('calm');
            setMiniWizardMood('calm');
            setEndWizardMood('calm');
        }

        function flipStartCard() {
            const card = document.getElementById('start-card');
            if (!card.classList.contains('flipped')) {
                card.classList.add('flipped');
                setMiniWizardMood('pleased');
                // Initialize TTS
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(utterance);
                }
            }
        }

        function startGame(event) {
            event.stopPropagation();

            // Start music
            music.volume = 0.3;
            music.play().catch(err => console.log('Audio:', err));

            // Hide overlay
            document.getElementById('start-overlay').classList.add('hidden');

            // Start the game with gentle pacing
            setTimeout(() => {
                drawCards();
            }, 1000);

            setTimeout(() => {
                wizardSpeak(randomFrom(DIALOGUE.start));
                // Smile after speaking
                setTimeout(() => {
                    setWizardMood('pleased');
                }, 2500);
            }, 1800);
        }

        // ============================================
        // WIZARD
        // ============================================
        function setWizardMood(mood) {
            const face = WIZARD_FACES[mood];
            if (!face) return;

            face.pattern.forEach((state, index) => {
                if (state === 1) {
                    leds[index].classList.add('on');
                    leds[index].style.setProperty('--led-color', face.color);
                } else {
                    leds[index].classList.remove('on');
                }
            });
        }

        function setMiniWizardMood(mood) {
            const face = WIZARD_FACES[mood];
            if (!face) return;

            face.pattern.forEach((state, index) => {
                if (state === 1) {
                    miniLeds[index].classList.add('on');
                } else {
                    miniLeds[index].classList.remove('on');
                }
            });
        }

        function setEndWizardMood(mood) {
            const face = WIZARD_FACES[mood];
            if (!face) return;

            face.pattern.forEach((state, index) => {
                if (state === 1) {
                    endLeds[index].classList.add('on');
                } else {
                    endLeds[index].classList.remove('on');
                }
            });
        }

        // ============================================
        // AUDIO EFFECTS
        // ============================================
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playCompletionSound() {
            try {
                const ctx = initAudio();
                const now = ctx.currentTime;

                // Create a gentle, warm completion sound
                // Multiple harmonics for a rich tone
                const frequencies = [392, 523.25, 659.25, 783.99]; // G4, C5, E5, G5 - a resolved chord

                frequencies.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now);

                    // Stagger the notes slightly for an arpeggio effect
                    const startTime = now + i * 0.15;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.08, startTime + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 2.5);

                    osc.start(startTime);
                    osc.stop(startTime + 3);
                });

                // Add a soft bell-like overtone
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1046.5, ctx.currentTime); // C6
                    gain.gain.setValueAtTime(0.04, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2);
                    osc.start();
                    osc.stop(ctx.currentTime + 2);
                }, 600);

            } catch (e) {
                console.log('Audio not available:', e);
            }
        }

        function fadeMusicTo(targetVolume, duration = 3000) {
            const startVolume = music.volume;
            const steps = 40;
            const stepTime = duration / steps;
            const volumeDiff = targetVolume - startVolume;
            const volumeStep = volumeDiff / steps;

            let currentStep = 0;
            const fadeInterval = setInterval(() => {
                currentStep++;
                music.volume = Math.max(0, Math.min(0.5, startVolume + (volumeStep * currentStep)));

                if (currentStep >= steps) {
                    clearInterval(fadeInterval);
                    music.volume = targetVolume;
                }
            }, stepTime);
        }

        function fadeOutMusic(duration = 4000) {
            fadeMusicTo(0, duration);
            setTimeout(() => {
                music.pause();
                music.volume = 0.3; // Reset for next play
            }, duration + 100);
        }

        function fadeInMusic(duration = 3000) {
            music.volume = 0;
            music.play().catch(err => console.log('Audio:', err));
            fadeMusicTo(0.3, duration);
        }

        function wizardSpeak(text) {
            document.getElementById('wizard-text').textContent = text;

            if (game.ttsEnabled && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.85;
                utterance.pitch = 0.9;
                utterance.volume = 0.8;

                // Try to find a suitable voice
                const voices = window.speechSynthesis.getVoices();
                const preferred = voices.find(v =>
                    v.name.includes('Google') || v.name.includes('Microsoft')
                );
                if (preferred) utterance.voice = preferred;

                window.speechSynthesis.speak(utterance);
            }
        }

        // ============================================
        // CARDS
        // ============================================
        function getStoryPhase() {
            const cardCount = game.story.length;
            if (cardCount === 0) return 'opening';
            if (cardCount < 5) return 'middle';
            if (cardCount < 7) return 'complication';
            return 'closing';
        }

        function getAvailableRoles() {
            const phase = getStoryPhase();
            switch (phase) {
                case 'opening':
                    // Only tone and place cards to set atmosphere
                    return ['tone', 'place'];
                case 'middle':
                    // All cards except problem and resolution
                    return ['character', 'place', 'action', 'object', 'tone'];
                case 'complication':
                    // Problem cards become available
                    return ['character', 'place', 'action', 'object', 'tone', 'problem'];
                case 'closing':
                    // Resolution cards become available
                    return ['character', 'place', 'action', 'object', 'tone', 'problem', 'resolution'];
                default:
                    return ['character', 'place', 'action', 'object', 'tone'];
            }
        }

        function announcePhaseTransition(phase) {
            let dialogue, mood;
            switch (phase) {
                case 'middle':
                    dialogue = DIALOGUE.phaseMiddle;
                    mood = 'curious';
                    break;
                case 'complication':
                    dialogue = DIALOGUE.phaseComplication;
                    mood = 'unsettled';
                    break;
                case 'closing':
                    dialogue = DIALOGUE.phaseClosing;
                    mood = 'thinking';
                    break;
                default:
                    return; // No announcement for opening
            }

            setTimeout(() => {
                wizardSpeak(randomFrom(dialogue));
                setWizardMood(mood);
            }, 800);
        }

        function drawCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            // Get available roles for current story phase
            const allowedRoles = getAvailableRoles();
            const usedIds = game.story.map(c => c.id);

            // Filter cards by phase and not already used
            let available = CARDS.filter(c =>
                !usedIds.includes(c.id) && allowedRoles.includes(c.role)
            );

            // In closing phase, ensure at least one resolution card is offered if available
            const phase = getStoryPhase();
            if (phase === 'closing') {
                const resolutionCards = available.filter(c => c.role === 'resolution');
                const otherCards = available.filter(c => c.role !== 'resolution');

                if (resolutionCards.length > 0 && otherCards.length >= 2) {
                    // Guarantee one resolution card
                    const shuffledResolutions = resolutionCards.sort(() => Math.random() - 0.5);
                    const shuffledOthers = otherCards.sort(() => Math.random() - 0.5);
                    game.currentCards = [
                        shuffledResolutions[0],
                        shuffledOthers[0],
                        shuffledOthers[1]
                    ].sort(() => Math.random() - 0.5); // Randomize order
                } else {
                    available = available.sort(() => Math.random() - 0.5);
                    game.currentCards = available.slice(0, 3);
                }
            } else if (phase === 'complication') {
                // In complication phase, ensure at least one problem card is offered if available
                const problemCards = available.filter(c => c.role === 'problem');
                const otherCards = available.filter(c => c.role !== 'problem');

                if (problemCards.length > 0 && otherCards.length >= 2) {
                    const shuffledProblems = problemCards.sort(() => Math.random() - 0.5);
                    const shuffledOthers = otherCards.sort(() => Math.random() - 0.5);
                    game.currentCards = [
                        shuffledProblems[0],
                        shuffledOthers[0],
                        shuffledOthers[1]
                    ].sort(() => Math.random() - 0.5);
                } else {
                    available = available.sort(() => Math.random() - 0.5);
                    game.currentCards = available.slice(0, 3);
                }
            } else {
                // Opening and middle phases - just shuffle and take 3
                available = available.sort(() => Math.random() - 0.5);
                game.currentCards = available.slice(0, 3);
            }

            if (game.currentCards.length < 3) {
                // Not enough cards - trigger end state
                endGame();
                return;
            }

            // Check for phase transition and announce
            const currentPhase = getStoryPhase();
            if (currentPhase !== game.lastPhase) {
                announcePhaseTransition(currentPhase);
                game.lastPhase = currentPhase;
            }

            // Create card elements
            game.currentCards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'story-card';
                cardEl.dataset.role = card.role;
                cardEl.dataset.index = index;

                cardEl.innerHTML = `
                    <div class="card-face card-front"></div>
                    <div class="card-face card-back">
                        <div class="card-type">${card.role}</div>
                        <div class="card-title">${card.title}</div>
                        <div class="card-text">${card.text}</div>
                        <div class="card-tone">${card.tone} / ${card.theme}</div>
                    </div>
                `;

                // Click to flip, click again to select
                cardEl.addEventListener('click', () => {
                    if (cardEl.classList.contains('faded')) return;

                    if (!cardEl.classList.contains('flipped')) {
                        // First click - flip to reveal
                        cardEl.classList.add('flipped');
                    } else {
                        // Second click - select
                        selectCard(index);
                    }
                });

                container.appendChild(cardEl);

                // Stagger entrance animation with longer delays
                setTimeout(() => {
                    cardEl.classList.add('visible');
                }, 100 + index * 300);
            });

            // Wizard becomes curious after cards appear
            setTimeout(() => {
                setWizardMood('curious');
            }, 600);
        }

        function selectCard(index) {
            const cards = document.querySelectorAll('.story-card');
            const selected = game.currentCards[index];

            // Mark selected and fade others
            cards.forEach((card, i) => {
                if (i === index) {
                    card.classList.add('selected', 'flipped');
                } else {
                    card.classList.add('faded');
                }
            });

            // Add to story
            game.story.push(selected);
            updateCoherence(selected);
            addToStoryLog(selected);

            // Update tell story button state
            updateTellStoryButton();

            // Check for chapter milestone (every 3 cards)
            if (game.story.length % 3 === 0 && game.story.length < 12) {
                // Chapter narration after wizard reaction
                setTimeout(() => {
                    const chapterReaction = getChapterReaction();
                    wizardSpeak(chapterReaction);
                    setWizardMood('pleased');
                }, 1600);

                // Then draw new cards
                setTimeout(() => {
                    if (game.story.length >= 12) {
                        endGame();
                    } else {
                        drawCards();
                    }
                }, 5000);
            } else {
                // Wizard reacts after card flip completes
                const reaction = getWizardReaction(selected);
                setTimeout(() => {
                    setWizardMood('thinking');
                }, 800);

                setTimeout(() => {
                    wizardSpeak(reaction.text);
                    setWizardMood(reaction.mood);
                }, 1600);

                // Check for auto-end at 12 cards
                setTimeout(() => {
                    if (game.story.length >= 12) {
                        endGame();
                    } else {
                        drawCards();
                    }
                }, 4000);
            }
        }

        // ============================================
        // COHERENCE TRACKING
        // ============================================
        function updateCoherence(card) {
            const c = game.coherence;

            // Track themes
            c.themes[card.theme] = (c.themes[card.theme] || 0) + 1;

            // Track tones
            c.tones[card.tone] = (c.tones[card.tone] || 0) + 1;

            // Track roles
            c.roles[card.role] = (c.roles[card.role] || 0) + 1;

            c.lastTone = card.tone;
        }

        function getWizardReaction(card) {
            const c = game.coherence;
            let mood = 'calm';
            let dialoguePool = DIALOGUE[card.tone] || DIALOGUE.calm;

            // Special reactions for problem and resolution cards
            if (card.role === 'problem') {
                dialoguePool = DIALOGUE.problem;
                mood = 'unsettled';
                return { text: randomFrom(dialoguePool), mood: mood };
            }

            if (card.role === 'resolution') {
                dialoguePool = DIALOGUE.resolution;
                mood = 'pleased';
                return { text: randomFrom(dialoguePool), mood: mood };
            }

            // Check for theme repeat
            if (c.themes[card.theme] > 1) {
                dialoguePool = DIALOGUE.themeRepeat;
                mood = 'pleased';
            }

            // Check for tone shift (if story has entries)
            if (game.story.length > 1) {
                const prevTone = game.story[game.story.length - 2].tone;
                if (prevTone !== card.tone) {
                    if (Math.random() < 0.4) {
                        dialoguePool = DIALOGUE.toneShift;
                        mood = 'curious';
                    }
                }
            }

            // Mood based on card tone
            if (card.tone === 'warm' || card.tone === 'hopeful') mood = 'pleased';
            if (card.tone === 'tense') mood = 'unsettled';
            if (card.tone === 'strange') mood = 'curious';

            return {
                text: randomFrom(dialoguePool),
                mood: mood
            };
        }

        // ============================================
        // STORY LOG
        // ============================================
        function addToStoryLog(card) {
            const log = document.getElementById('story-log');

            // Remove empty message
            const empty = log.querySelector('.story-empty');
            if (empty) empty.remove();

            // Add entry
            const entry = document.createElement('div');
            entry.className = 'story-entry';
            entry.innerHTML = `
                <div class="story-entry-title">${card.title}</div>
                <div class="story-entry-text">${card.text}</div>
            `;
            log.appendChild(entry);

            // Update count
            document.getElementById('story-count').textContent =
                `${game.story.length} card${game.story.length !== 1 ? 's' : ''}`;

            // Scroll to bottom
            log.scrollTop = log.scrollHeight;
        }

        // ============================================
        // CONTROLS
        // ============================================
        function toggleTTS() {
            game.ttsEnabled = !game.ttsEnabled;
            document.getElementById('tts-toggle').textContent =
                `voice: ${game.ttsEnabled ? 'on' : 'off'}`;
        }

        function updateTellStoryButton() {
            const btn = document.getElementById('tell-story-btn');
            if (game.story.length >= 8) {
                btn.classList.add('ready');
            } else {
                btn.classList.remove('ready');
            }
        }

        function tellStory() {
            if (game.story.length >= 8) {
                endGame();
            }
        }

        function getChapterReaction() {
            const chapterNum = Math.floor(game.story.length / 3);
            const chapterDialogue = {
                1: [
                    "The first threads are woven. I can feel the shape of something beginning to form.",
                    "A beginning takes shape. The story is finding its voice now.",
                    "The story finds its footing. Already I sense where it might want to go."
                ],
                2: [
                    "The middle deepens. Patterns emerge that were not there before.",
                    "Patterns begin to emerge. The threads you have chosen are weaving together.",
                    "The tale gathers weight. Each card you choose echoes what came before."
                ],
                3: [
                    "The arc bends toward completion. Soon I will share what we have built.",
                    "All threads draw together. The story knows its ending is near.",
                    "The ending approaches. One or two more cards, and I will tell your tale."
                ]
            };

            const pool = chapterDialogue[chapterNum] || chapterDialogue[3];
            return randomFrom(pool);
        }

        function newStory() {
            game.story = [];
            game.storyPhrases = null;
            game.lastPhase = 'opening';
            game.coherence = { themes: {}, tones: {}, roles: {}, lastTone: null };

            const log = document.getElementById('story-log');
            log.innerHTML = '<p class="story-empty">Your story will unfold here...</p>';
            document.getElementById('story-count').textContent = '0 cards';

            // Reset tell story button
            document.getElementById('tell-story-btn').classList.remove('ready');

            // Gentle reset with calm wizard
            setWizardMood('calm');

            setTimeout(() => {
                drawCards();
            }, 400);

            setTimeout(() => {
                wizardSpeak(randomFrom(DIALOGUE.start));
                // Smile after speaking
                setTimeout(() => {
                    setWizardMood('pleased');
                }, 2500);
            }, 1200);
        }

        // ============================================
        // END GAME
        // ============================================
        function endGame() {
            // Clear the cards container
            document.getElementById('cards-container').innerHTML = '';

            // Dim main content
            document.querySelector('.container').classList.add('dimmed');

            // Play completion sound
            setTimeout(() => {
                playCompletionSound();
            }, 500);

            // Wizard announces completion
            setWizardMood('pleased');
            wizardSpeak("The story is complete. Let me share what we built together...");

            // Fade music to half volume for story reading
            setTimeout(() => {
                fadeMusicTo(0.15, 4000);
            }, 2000);

            // Show end overlay
            setTimeout(() => {
                showEndOverlay();
            }, 3000);
        }

        function showEndOverlay() {
            const overlay = document.getElementById('end-overlay');
            const card = document.getElementById('end-card');
            const summary = document.getElementById('end-story-summary');
            const farewell = document.getElementById('farewell-text');
            const newBtn = document.getElementById('new-story-btn');

            // Set story summary
            summary.textContent = `${game.story.length} cards woven together`;

            // Set end wizard mood
            setEndWizardMood('pleased');

            // Activate overlay
            overlay.classList.add('active');

            // Show card
            setTimeout(() => {
                card.classList.add('visible');
            }, 800);

            // Read the story aloud if TTS enabled
            setTimeout(() => {
                readStoryAloud();
            }, 2500);
        }

        function readStoryAloud() {
            // Build story parts for sequential display
            const storyParts = getStoryParts();
            const ttsStory = stitchStoryBeats(false);
            const storyTextEl = document.getElementById('end-story-text');

            // If no TTS, just cycle through visuals
            if (!game.ttsEnabled || !('speechSynthesis' in window)) {
                displayBeatsSequentially(storyParts, storyTextEl, false);
                return;
            }

            window.speechSynthesis.cancel();

            // Create utterance for full story
            const utterance = new SpeechSynthesisUtterance(ttsStory);
            utterance.rate = 0.7; // Slower for dramatic effect
            utterance.pitch = 0.85;
            utterance.volume = 0.9;

            // Try to find a suitable voice
            const voices = window.speechSynthesis.getVoices();
            const preferred = voices.find(v =>
                v.name.includes('Google') || v.name.includes('Microsoft')
            );
            if (preferred) utterance.voice = preferred;

            // When done reading, show farewell
            utterance.onend = () => {
                setTimeout(() => {
                    storyTextEl.classList.add('fade-out');
                    setTimeout(() => showFarewellElements(), 1000);
                }, 1000);
            };

            // Handle errors
            utterance.onerror = () => {
                storyTextEl.classList.add('fade-out');
                setTimeout(() => showFarewellElements(), 1000);
            };

            // Update end wizard during reading
            setEndWizardMood('calm');

            // Start TTS and display beats in sync
            window.speechSynthesis.speak(utterance);
            displayBeatsSequentially(storyParts, storyTextEl, true);
        }

        function getStoryParts() {
            const beats = game.story.map(card => card.beat);
            const storyLength = beats.length;

            if (storyLength === 0) return [];
            if (storyLength === 1) return [`Once, ${beats[0]}.`];

            // Use stored phrases if available
            if (!game.storyPhrases || game.storyPhrases.length !== storyLength) {
                game.storyPhrases = generateStitchingPhrases(storyLength);
            }

            return beats.map((beat, index) => `${game.storyPhrases[index]} ${beat}.`);
        }

        function generateStitchingPhrases(storyLength) {
            // Expanded stitching phrases
            const openings = [
                'Once,', 'At the beginning,', 'In the beginning,',
                'It began when', 'There came a time when', 'Long ago,'
            ];
            const middles = [
                'Then,', 'Along the way,', 'And so,', 'In time,',
                'Before long,', 'As the journey continued,', 'Soon after,',
                'Not long after,', 'And then,', 'Eventually,',
                'As time passed,', 'Later,', 'When the moment came,'
            ];
            const complications = [
                'But then,', 'However,', 'Yet,', 'Unexpectedly,',
                'Against all odds,', 'Despite this,', 'Even so,'
            ];
            const endings = [
                'At last,', 'In the end,', 'Finally,', 'And so it was that',
                'When all was said and done,', 'In the final moment,', 'At journey\'s end,'
            ];

            const phrases = [];
            let lastPhrase = null;

            for (let i = 0; i < storyLength; i++) {
                let pool;
                if (i === 0) {
                    pool = openings;
                } else if (i === storyLength - 1) {
                    pool = endings;
                } else if (i >= 5 && i < storyLength - 2) {
                    // Complication phase - mix in complication phrases
                    pool = [...middles, ...complications];
                } else {
                    pool = middles;
                }

                // Pick a phrase that's different from the last one
                let phrase = randomFromExcluding(pool, lastPhrase);
                phrases.push(phrase);
                lastPhrase = phrase;
            }

            return phrases;
        }

        function randomFromExcluding(arr, exclude) {
            const filtered = arr.filter(item => item !== exclude);
            return filtered.length > 0 ? randomFrom(filtered) : randomFrom(arr);
        }

        function displayBeatsSequentially(parts, element, withTTS) {
            if (parts.length === 0) {
                setTimeout(() => showFarewellElements(), 2000);
                return;
            }

            let currentIndex = 0;

            function showNextBeat() {
                if (currentIndex >= parts.length) {
                    if (!withTTS) {
                        // No TTS - fade out and show farewell
                        setTimeout(() => {
                            element.classList.add('fade-out');
                            setTimeout(() => showFarewellElements(), 1000);
                        }, 2000);
                    }
                    return;
                }

                const beat = parts[currentIndex];
                const wordCount = beat.split(' ').length;
                // Estimate duration: ~0.55 seconds per word at rate 0.7
                const duration = Math.max(2500, wordCount * 550);

                // Fade out current
                element.classList.remove('visible');
                element.classList.add('fade-out');

                setTimeout(() => {
                    // Update text
                    element.innerHTML = `"${beat}"`;
                    element.classList.remove('fade-out');

                    // Small delay then fade in
                    setTimeout(() => {
                        element.classList.add('visible');
                    }, 100);

                    currentIndex++;

                    // Schedule next beat
                    setTimeout(showNextBeat, duration);
                }, 400);
            }

            // Start showing beats
            showNextBeat();
        }

        function stitchStoryBeats(forDisplay = false) {
            const beats = game.story.map(card => card.beat);
            const storyLength = beats.length;

            if (storyLength === 0) return '';
            if (storyLength === 1) return `Once, ${beats[0]}.`;

            // Use stored phrases if available (so display and TTS match)
            if (!game.storyPhrases || game.storyPhrases.length !== storyLength) {
                game.storyPhrases = generateStitchingPhrases(storyLength);
            }

            let parts = beats.map((beat, index) => `${game.storyPhrases[index]} ${beat}.`);

            if (forDisplay) {
                return parts.join('<br><br>');
            } else {
                return parts.join(' ');
            }
        }

        function showFarewellElements() {
            const farewell = document.getElementById('farewell-text');
            const newBtn = document.getElementById('new-story-btn');

            // Show farewell text
            farewell.classList.add('visible');
            setEndWizardMood('pleased');

            // Speak farewell
            if (game.ttsEnabled && 'speechSynthesis' in window) {
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance("Thank you for sharing this story with me.");
                    utterance.rate = 0.8;
                    utterance.pitch = 0.9;
                    utterance.volume = 0.8;

                    const voices = window.speechSynthesis.getVoices();
                    const preferred = voices.find(v =>
                        v.name.includes('Google') || v.name.includes('Microsoft')
                    );
                    if (preferred) utterance.voice = preferred;

                    window.speechSynthesis.speak(utterance);
                }, 500);
            }

            // Show new story button
            setTimeout(() => {
                newBtn.classList.add('visible');
            }, 2000);
        }

        function startNewStoryFromEnd() {
            const overlay = document.getElementById('end-overlay');
            const card = document.getElementById('end-card');
            const storyText = document.getElementById('end-story-text');
            const farewell = document.getElementById('farewell-text');
            const newBtn = document.getElementById('new-story-btn');

            // Cancel any ongoing speech
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }

            // Hide end elements
            newBtn.classList.remove('visible');
            farewell.classList.remove('visible');
            storyText.classList.remove('visible');
            card.classList.remove('visible');

            setTimeout(() => {
                overlay.classList.remove('active');
            }, 600);

            // Remove dim from main content
            setTimeout(() => {
                document.querySelector('.container').classList.remove('dimmed');
            }, 800);

            // Fade music back to full volume
            setTimeout(() => {
                fadeMusicTo(0.3, 3000);
            }, 1000);

            // Reset game state
            setTimeout(() => {
                game.story = [];
                game.storyPhrases = null;
                game.lastPhase = 'opening';
                game.coherence = { themes: {}, tones: {}, roles: {}, lastTone: null };

                const log = document.getElementById('story-log');
                log.innerHTML = '<p class="story-empty">Your story will unfold here...</p>';
                document.getElementById('story-count').textContent = '0 cards';

                // Reset end card story text
                document.getElementById('end-story-text').textContent = '';

                // Reset tell story button
                document.getElementById('tell-story-btn').classList.remove('ready');

                setWizardMood('calm');
            }, 1200);

            // Start new story
            setTimeout(() => {
                drawCards();
            }, 1800);

            setTimeout(() => {
                wizardSpeak(randomFrom(DIALOGUE.start));
                // Smile after speaking
                setTimeout(() => {
                    setWizardMood('pleased');
                }, 2500);
            }, 2600);
        }

        // ============================================
        // UTILITIES
        // ============================================
        function randomFrom(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Load voices
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        // Initialize
        init();
    </script>
</body>
</html>
