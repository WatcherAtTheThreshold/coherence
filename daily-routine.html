<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAILY ROUTINE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Cormorant+Garamond:wght@400;500;600&display=swap');

        :root {
            --void: #0d0d12;
            --room-floor: #1a1816;
            --room-wall: #12100e;
            --text-dim: #5a5550;
            --text-mid: #8a8580;
            --text-bright: #d4cdc0;
            --accent-gold: #d4a574;
            --accent-warm: #c07050;
            --station-glow: rgba(212, 165, 116, 0.15);
            --station-active: rgba(212, 165, 116, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--void);
            color: var(--text-bright);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ========== GAME CONTAINER ========== */
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(180deg, var(--room-wall) 0%, var(--room-floor) 60%);
        }

        /* Ambient particles */
        .dust-particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(212, 165, 116, 0.3);
            border-radius: 50%;
            pointer-events: none;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
            50% { transform: translateY(-30px) translateX(10px); opacity: 0.6; }
        }

        /* ========== ROOM LAYOUT ========== */
        .room {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 500px;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding-bottom: 40px;
        }

        /* ========== STATIONS ========== */
        .station {
            width: 240px;
            height: 280px;
            background: linear-gradient(180deg, rgba(30, 28, 26, 0.9) 0%, rgba(20, 18, 16, 0.95) 100%);
            border: 2px solid rgba(212, 165, 116, 0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
        }

        .station::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 40px;
            background: radial-gradient(ellipse, var(--station-glow) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .station:hover {
            border-color: rgba(212, 165, 116, 0.5);
            transform: translateY(-5px);
        }

        .station:hover::before {
            opacity: 1;
        }

        .station.active {
            border-color: var(--accent-gold);
            box-shadow: 0 0 30px var(--station-glow);
        }

        .station.active::before {
            opacity: 1;
            background: radial-gradient(ellipse, var(--station-active) 0%, transparent 70%);
        }

        .station-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .station-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
            letter-spacing: 0.1rem;
        }

        .station-projects {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: center;
            line-height: 1.6;
        }

        /* ========== WIZARD ========== */
        .wizard-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            z-index: 100;
        }

        .wizard-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 6px;
            width: 80px;
            height: 80px;
        }

        .led {
            aspect-ratio: 1;
            border-radius: 50%;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .led.on {
            background: var(--accent-gold);
            box-shadow: 0 0 4px var(--accent-gold);
        }

        .wizard-speech {
            background: rgba(0, 0, 0, 0.6);
            border-left: 2px solid var(--accent-gold);
            padding: 0.8rem 1rem;
            max-width: 280px;
            border-radius: 0 6px 6px 0;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.4s ease;
        }

        .wizard-speech.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .wizard-speech p {
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-bright);
            font-style: italic;
        }

        /* ========== HUD ========== */
        .hud {
            position: fixed;
            top: 20px;
            right: 20px;
            text-align: right;
        }

        .hud-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            letter-spacing: 0.2rem;
            margin-bottom: 0.5rem;
        }

        .hud-stats {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .hud-stats span {
            color: var(--text-mid);
        }

        /* ========== MINI-GAME OVERLAY ========== */
        #minigame-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        #minigame-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .minigame-container {
            width: 700px;
            max-height: 80vh;
            background: linear-gradient(180deg, #1e1c1a 0%, #141210 100%);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            padding: 2rem;
            position: relative;
        }

        .minigame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(212, 165, 116, 0.2);
        }

        .minigame-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            color: var(--accent-gold);
        }

        .minigame-close {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 0.4rem 0.8rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .minigame-close:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .minigame-content {
            min-height: 300px;
        }

        /* ========== WRITING MINI-GAME ========== */
        .writing-game {
            position: relative;
        }

        .writing-prompt {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .writing-prompt .label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .writing-prompt .prompt-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            color: var(--text-bright);
            font-style: italic;
        }

        .writing-tunnel {
            height: 200px;
            background: linear-gradient(180deg, #0a0a0f 0%, #1a1816 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .thought-orb {
            position: absolute;
            padding: 0.5rem 1rem;
            background: rgba(212, 165, 116, 0.2);
            border: 1px solid var(--accent-gold);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-bright);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: orbFloat 3s ease-in-out infinite;
        }

        .thought-orb:hover {
            background: rgba(212, 165, 116, 0.4);
            transform: scale(1.05);
        }

        .thought-orb.caught {
            background: var(--accent-gold);
            color: var(--void);
            animation: none;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .writing-output {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 165, 116, 0.2);
            border-radius: 6px;
            padding: 1rem;
            min-height: 60px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            color: var(--text-mid);
            font-style: italic;
        }

        .writing-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .flow-meter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .flow-bar {
            width: 100px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .flow-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-warm), var(--accent-gold));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ========== MUSIC MINI-GAME ========== */
        .music-game {
            text-align: center;
        }

        .radial-sequencer {
            width: 300px;
            height: 300px;
            margin: 0 auto 1.5rem;
            position: relative;
        }

        .sequencer-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(212, 165, 116, 0.3);
            border-radius: 50%;
        }

        .sequencer-ring.outer { width: 280px; height: 280px; }
        .sequencer-ring.middle { width: 200px; height: 200px; }
        .sequencer-ring.inner { width: 120px; height: 120px; }

        .playhead {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 140px;
            background: linear-gradient(180deg, var(--accent-gold), transparent);
            transform-origin: bottom center;
            transform: translateX(-50%);
            animation: spin 4s linear infinite paused;
        }

        .playhead.playing {
            animation-play-state: running;
        }

        @keyframes spin {
            from { transform: translateX(-50%) rotate(0deg); }
            to { transform: translateX(-50%) rotate(360deg); }
        }

        .node {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .node:hover {
            transform: scale(1.3);
        }

        .node.bass { background: #8e6b6b; box-shadow: 0 0 10px #8e6b6b; }
        .node.melody { background: #6b8e7d; box-shadow: 0 0 10px #6b8e7d; }
        .node.percussion { background: #8e7d6b; box-shadow: 0 0 10px #8e7d6b; }

        .node.hit {
            animation: nodeHit 0.2s ease;
        }

        @keyframes nodeHit {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        .vibe-meter {
            margin-bottom: 1rem;
        }

        .vibe-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .vibe-target {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: var(--accent-gold);
        }

        .node-palette {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .palette-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: var(--void);
            font-weight: bold;
        }

        .palette-node:hover {
            transform: scale(1.1);
        }

        .palette-node.bass { background: #8e6b6b; }
        .palette-node.melody { background: #6b8e7d; }
        .palette-node.percussion { background: #8e7d6b; }

        .music-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .music-btn {
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 0.6rem 1.5rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .music-btn:hover {
            background: var(--accent-gold);
            color: var(--void);
        }

        /* ========== PROJECT SELECTOR ========== */
        .project-selector {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .project-option {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 165, 116, 0.2);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .project-option:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 165, 116, 0.1);
        }

        .project-icon {
            font-size: 1.5rem;
        }

        .project-info h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: var(--text-bright);
            margin-bottom: 0.25rem;
        }

        .project-info p {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* ========== SCORE DISPLAY ========== */
        .score-display {
            text-align: center;
            padding: 2rem;
        }

        .score-display h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .score-value {
            font-size: 3rem;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
        }

        .score-label {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .score-btn {
            margin-top: 1.5rem;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 0.6rem 2rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .score-btn:hover {
            background: var(--accent-gold);
            color: var(--void);
        }

        /* ========== INSTRUCTIONS ========== */
        .instructions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Room with Stations -->
        <div class="room">
            <!-- Station 1: Music -->
            <div class="station" id="station-music" onclick="openStation('music')">
                <div class="station-icon">üéπ</div>
                <div class="station-name">The Keyboard</div>
                <div class="station-projects">music composition<br>sound design</div>
            </div>

            <!-- Station 2: Digital Work -->
            <div class="station" id="station-digital" onclick="openStation('digital')">
                <div class="station-icon">üñ•Ô∏è</div>
                <div class="station-name">The Workstation</div>
                <div class="station-projects">writing / coding<br>digital drawing</div>
            </div>

            <!-- Station 3: Physical Craft -->
            <div class="station" id="station-craft" onclick="openStation('craft')">
                <div class="station-icon">ü™µ</div>
                <div class="station-name">The Workshop</div>
                <div class="station-projects">painting<br>woodworking</div>
            </div>
        </div>

        <!-- Wizard -->
        <div class="wizard-container">
            <div class="wizard-grid" id="wizard-grid"></div>
            <div class="wizard-speech" id="wizard-speech">
                <p id="wizard-text"></p>
            </div>
        </div>

        <!-- HUD -->
        <div class="hud">
            <div class="hud-title">Daily Routine</div>
            <div class="hud-stats">
                projects completed: <span id="projects-count">0</span><br>
                creative energy: <span id="energy-display">100%</span>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            click a station to begin
        </div>
    </div>

    <!-- Mini-game Overlay -->
    <div id="minigame-overlay">
        <div class="minigame-container">
            <div class="minigame-header">
                <div class="minigame-title" id="minigame-title">Select Project</div>
                <button class="minigame-close" onclick="closeMinigame()">‚Üê back</button>
            </div>
            <div class="minigame-content" id="minigame-content">
                <!-- Dynamic content loaded here -->
            </div>
        </div>
    </div>

    <audio id="music" loop>
        <source src="music/daily-routine.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ============================================
        // GAME STATE
        // ============================================
        const game = {
            projectsCompleted: 0,
            energy: 100,
            currentStation: null,
            currentProject: null,
            scores: {
                writing: [],
                music: [],
                drawing: [],
                coding: [],
                painting: [],
                woodworking: []
            },
            ttsEnabled: true
        };

        // ============================================
        // WIZARD
        // ============================================
        const WIZARD_FACES = {
            calm: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,1,1,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ]
            },
            curious: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,1,1,1,1,0,0,0,
                    0,0,1,0,0,0,0,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ]
            },
            pleased: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,1,0,0,0,0,0,0,1,0,
                    0,0,1,0,0,0,0,1,0,0,
                    0,0,0,1,1,1,1,0,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ]
            },
            thinking: {
                pattern: [
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,1,1,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,1,1,0,0,0,0,
                    0,0,0,0,0,0,1,1,0,0,
                    0,0,0,0,0,0,0,0,0,0
                ]
            }
        };

        const WIZARD_DIALOGUE = {
            greeting: [
                "Another day in the studio. What shall we make?",
                "The workspace awaits. Where will you begin?",
                "Creativity stirs. Choose your path."
            ],
            music: [
                "Music speaks where words cannot.",
                "Let rhythm guide your hands.",
                "Every note tells a story."
            ],
            writing: [
                "Words flow like water when we let them.",
                "The blank page is a friend, not a foe.",
                "Capture the thoughts before they drift away."
            ],
            coding: [
                "Logic and creativity intertwined.",
                "Each function is a small poem.",
                "Build something that thinks."
            ],
            drawing: [
                "See the world in lines and curves.",
                "The gesture holds the spirit.",
                "Let your hand follow your eye."
            ],
            painting: [
                "Colors speak their own language.",
                "Mix, blend, discover.",
                "The canvas is patient."
            ],
            woodworking: [
                "Feel the grain beneath your fingers.",
                "Patience reveals the form within.",
                "Subtract to create."
            ],
            complete: [
                "Well done. The work is its own reward.",
                "Another piece finds its shape.",
                "Creation complete. What's next?"
            ]
        };

        let leds = [];

        function initWizard() {
            const grid = document.getElementById('wizard-grid');
            for (let i = 0; i < 100; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                grid.appendChild(led);
                leds.push(led);
            }
            setWizardMood('calm');
        }

        function setWizardMood(mood) {
            const face = WIZARD_FACES[mood];
            if (!face) return;

            face.pattern.forEach((state, index) => {
                if (state === 1) {
                    leds[index].classList.add('on');
                } else {
                    leds[index].classList.remove('on');
                }
            });
        }

        function wizardSpeak(text, mood = 'calm') {
            const speech = document.getElementById('wizard-speech');
            const textEl = document.getElementById('wizard-text');

            textEl.textContent = text;
            speech.classList.add('visible');
            setWizardMood(mood);

            // TTS
            if (game.ttsEnabled && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.85;
                utterance.pitch = 0.9;
                utterance.volume = 0.7;
                window.speechSynthesis.speak(utterance);
            }

            // Hide after delay
            setTimeout(() => {
                speech.classList.remove('visible');
            }, 5000);
        }

        // ============================================
        // STATION MANAGEMENT
        // ============================================
        const STATION_PROJECTS = {
            music: [
                { id: 'music', name: 'The Pulse Weaver', desc: 'Compose with the radial sequencer', icon: 'üéµ' }
            ],
            digital: [
                { id: 'writing', name: 'Stream of Consciousness', desc: 'Catch thoughts and form sentences', icon: '‚úçÔ∏è' },
                { id: 'coding', name: 'Logic Leak', desc: 'Route data and fix bugs', icon: 'üíª' },
                { id: 'drawing', name: 'Line of Action', desc: 'Capture the gesture in one stroke', icon: '‚úèÔ∏è' }
            ],
            craft: [
                { id: 'painting', name: 'The Chroma Alchemist', desc: 'Mix colors and paint targets', icon: 'üé®' },
                { id: 'woodworking', name: 'Grain & Gauge', desc: 'Shape wood with precision', icon: 'ü™ö' }
            ]
        };

        function openStation(stationId) {
            game.currentStation = stationId;

            // Highlight active station
            document.querySelectorAll('.station').forEach(s => s.classList.remove('active'));
            document.getElementById(`station-${stationId}`).classList.add('active');

            // Show project selector
            showProjectSelector(stationId);

            // Wizard commentary
            const dialogueKey = stationId === 'digital' ? 'writing' : stationId === 'craft' ? 'painting' : 'music';
            wizardSpeak(randomFrom(WIZARD_DIALOGUE[dialogueKey]), 'curious');
        }

        function showProjectSelector(stationId) {
            const projects = STATION_PROJECTS[stationId];
            const content = document.getElementById('minigame-content');

            document.getElementById('minigame-title').textContent = 'Select Project';

            let html = '<div class="project-selector">';
            projects.forEach(project => {
                html += `
                    <div class="project-option" onclick="startProject('${project.id}')">
                        <div class="project-icon">${project.icon}</div>
                        <div class="project-info">
                            <h4>${project.name}</h4>
                            <p>${project.desc}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
            document.getElementById('minigame-overlay').classList.add('active');
        }

        function startProject(projectId) {
            game.currentProject = projectId;

            switch (projectId) {
                case 'writing':
                    startWritingGame();
                    break;
                case 'music':
                    startMusicGame();
                    break;
                case 'coding':
                    startCodingGame();
                    break;
                case 'drawing':
                    startDrawingGame();
                    break;
                case 'painting':
                    startPaintingGame();
                    break;
                case 'woodworking':
                    startWoodworkingGame();
                    break;
            }
        }

        function closeMinigame() {
            document.getElementById('minigame-overlay').classList.remove('active');
            document.querySelectorAll('.station').forEach(s => s.classList.remove('active'));
            game.currentStation = null;
            game.currentProject = null;
        }

        // ============================================
        // WRITING MINI-GAME
        // ============================================
        const WRITING_PROMPTS = [
            { theme: 'memory', words: ['once', 'there was', 'a place', 'where light', 'never faded'] },
            { theme: 'journey', words: ['they walked', 'through mist', 'and found', 'a door', 'that led home'] },
            { theme: 'creation', words: ['from nothing', 'came a spark', 'that grew', 'into something', 'beautiful'] },
            { theme: 'stillness', words: ['in the quiet', 'between breaths', 'the world', 'held still', 'and listened'] }
        ];

        let writingState = {
            prompt: null,
            caughtWords: [],
            flow: 0,
            orbs: []
        };

        function startWritingGame() {
            document.getElementById('minigame-title').textContent = 'Stream of Consciousness';

            writingState = {
                prompt: randomFrom(WRITING_PROMPTS),
                caughtWords: [],
                flow: 0,
                orbs: []
            };

            const content = document.getElementById('minigame-content');
            content.innerHTML = `
                <div class="writing-game">
                    <div class="writing-prompt">
                        <div class="label">theme</div>
                        <div class="prompt-text">${writingState.prompt.theme}</div>
                    </div>
                    <div class="writing-tunnel" id="writing-tunnel">
                        <!-- Thought orbs appear here -->
                    </div>
                    <div class="writing-output" id="writing-output">
                        <span class="placeholder">catch the words to build your sentence...</span>
                    </div>
                    <div class="writing-stats">
                        <div class="flow-meter">
                            flow: <div class="flow-bar"><div class="flow-fill" id="flow-fill"></div></div>
                        </div>
                        <div>words: <span id="word-count">0</span>/${writingState.prompt.words.length}</div>
                    </div>
                </div>
            `;

            // Spawn thought orbs
            spawnThoughtOrbs();

            wizardSpeak(randomFrom(WIZARD_DIALOGUE.writing), 'thinking');
        }

        function spawnThoughtOrbs() {
            const tunnel = document.getElementById('writing-tunnel');
            const words = writingState.prompt.words;

            // Shuffle positions
            const positions = words.map((_, i) => ({
                x: 20 + Math.random() * 60,
                y: 20 + Math.random() * 60
            }));

            words.forEach((word, index) => {
                const orb = document.createElement('div');
                orb.className = 'thought-orb';
                orb.textContent = word;
                orb.style.left = positions[index].x + '%';
                orb.style.top = positions[index].y + '%';
                orb.style.animationDelay = (index * 0.2) + 's';
                orb.dataset.index = index;
                orb.onclick = () => catchWord(orb, index);
                tunnel.appendChild(orb);
                writingState.orbs.push(orb);
            });
        }

        function catchWord(orb, index) {
            if (orb.classList.contains('caught')) return;

            const expectedIndex = writingState.caughtWords.length;
            const words = writingState.prompt.words;

            // Check if caught in correct order
            if (index === expectedIndex) {
                orb.classList.add('caught');
                writingState.caughtWords.push(words[index]);
                writingState.flow = Math.min(100, writingState.flow + 20);

                // Update display
                updateWritingOutput();
                document.getElementById('flow-fill').style.width = writingState.flow + '%';
                document.getElementById('word-count').textContent = writingState.caughtWords.length;

                // Check completion
                if (writingState.caughtWords.length === words.length) {
                    completeWritingGame();
                }
            } else {
                // Wrong order - shake effect
                orb.style.animation = 'none';
                orb.offsetHeight; // Trigger reflow
                orb.style.animation = 'orbFloat 3s ease-in-out infinite';
                writingState.flow = Math.max(0, writingState.flow - 10);
                document.getElementById('flow-fill').style.width = writingState.flow + '%';
            }
        }

        function updateWritingOutput() {
            const output = document.getElementById('writing-output');
            if (writingState.caughtWords.length > 0) {
                output.innerHTML = '"' + writingState.caughtWords.join(' ') + (writingState.caughtWords.length < writingState.prompt.words.length ? '...' : '.') + '"';
            }
        }

        function completeWritingGame() {
            const score = Math.round(writingState.flow * 1.5);
            game.scores.writing.push(score);
            game.projectsCompleted++;
            updateHUD();

            setTimeout(() => {
                showScore(score, 'writing');
                wizardSpeak(randomFrom(WIZARD_DIALOGUE.complete), 'pleased');
            }, 500);
        }

        // ============================================
        // MUSIC MINI-GAME
        // ============================================
        const VIBES = ['Melancholy', 'Energetic', 'Mysterious', 'Peaceful', 'Triumphant'];

        let musicState = {
            playing: false,
            nodes: [],
            targetVibe: '',
            score: 0
        };

        function startMusicGame() {
            document.getElementById('minigame-title').textContent = 'The Pulse Weaver';

            musicState = {
                playing: false,
                nodes: [],
                targetVibe: randomFrom(VIBES),
                score: 0
            };

            const content = document.getElementById('minigame-content');
            content.innerHTML = `
                <div class="music-game">
                    <div class="vibe-meter">
                        <div class="vibe-label">match the vibe</div>
                        <div class="vibe-target">${musicState.targetVibe}</div>
                    </div>
                    <div class="radial-sequencer" id="radial-sequencer">
                        <div class="sequencer-ring outer"></div>
                        <div class="sequencer-ring middle"></div>
                        <div class="sequencer-ring inner"></div>
                        <div class="playhead" id="playhead"></div>
                    </div>
                    <div class="node-palette">
                        <div class="palette-node bass" draggable="true" data-type="bass">BASS</div>
                        <div class="palette-node melody" draggable="true" data-type="melody">MELODY</div>
                        <div class="palette-node percussion" draggable="true" data-type="percussion">PERC</div>
                    </div>
                    <div class="music-controls">
                        <button class="music-btn" onclick="togglePlayback()">‚ñ∂ play</button>
                        <button class="music-btn" onclick="clearNodes()">clear</button>
                        <button class="music-btn" onclick="submitMusic()">submit</button>
                    </div>
                </div>
            `;

            setupMusicDragDrop();
            wizardSpeak(randomFrom(WIZARD_DIALOGUE.music), 'curious');
        }

        function setupMusicDragDrop() {
            const sequencer = document.getElementById('radial-sequencer');
            const paletteNodes = document.querySelectorAll('.palette-node');

            paletteNodes.forEach(node => {
                node.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('type', node.dataset.type);
                });
            });

            sequencer.addEventListener('dragover', (e) => e.preventDefault());
            sequencer.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                const rect = sequencer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                placeNode(type, x, y);
            });

            // Also allow clicking to place
            sequencer.addEventListener('click', (e) => {
                if (e.target.classList.contains('node')) return;
                const rect = sequencer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                // Cycle through types
                const types = ['bass', 'melody', 'percussion'];
                const type = types[musicState.nodes.length % 3];
                placeNode(type, x, y);
            });
        }

        function placeNode(type, x, y) {
            const sequencer = document.getElementById('radial-sequencer');
            const node = document.createElement('div');
            node.className = `node ${type}`;
            node.style.left = (x - 10) + 'px';
            node.style.top = (y - 10) + 'px';

            node.onclick = (e) => {
                e.stopPropagation();
                node.remove();
                musicState.nodes = musicState.nodes.filter(n => n.element !== node);
            };

            sequencer.appendChild(node);
            musicState.nodes.push({ type, x, y, element: node });

            // Play a sound feedback
            playNodeSound(type);
        }

        function playNodeSound(type) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                const frequencies = { bass: 110, melody: 440, percussion: 880 };
                osc.frequency.setValueAtTime(frequencies[type], ctx.currentTime);
                osc.type = type === 'percussion' ? 'square' : 'sine';

                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) {}
        }

        function togglePlayback() {
            const playhead = document.getElementById('playhead');
            musicState.playing = !musicState.playing;

            if (musicState.playing) {
                playhead.classList.add('playing');
            } else {
                playhead.classList.remove('playing');
            }
        }

        function clearNodes() {
            musicState.nodes.forEach(n => n.element.remove());
            musicState.nodes = [];
        }

        function submitMusic() {
            // Calculate score based on node variety and placement
            const hasTypes = new Set(musicState.nodes.map(n => n.type));
            const varietyBonus = hasTypes.size * 20;
            const placementScore = musicState.nodes.length * 10;
            const score = Math.min(100, varietyBonus + placementScore);

            game.scores.music.push(score);
            game.projectsCompleted++;
            updateHUD();

            showScore(score, 'music');
            wizardSpeak(randomFrom(WIZARD_DIALOGUE.complete), 'pleased');
        }

        // ============================================
        // PLACEHOLDER MINI-GAMES
        // ============================================
        function startCodingGame() {
            document.getElementById('minigame-title').textContent = 'Logic Leak';
            document.getElementById('minigame-content').innerHTML = `
                <div class="score-display">
                    <h3>Coming Soon</h3>
                    <p class="score-label">Route data packets and fix bugs in the Logic Leak mini-game.</p>
                    <button class="score-btn" onclick="closeMinigame()">return</button>
                </div>
            `;
            wizardSpeak(randomFrom(WIZARD_DIALOGUE.coding), 'thinking');
        }

        function startDrawingGame() {
            document.getElementById('minigame-title').textContent = 'Line of Action';
            document.getElementById('minigame-content').innerHTML = `
                <div class="score-display">
                    <h3>Coming Soon</h3>
                    <p class="score-label">Capture gestures with confident strokes in Line of Action.</p>
                    <button class="score-btn" onclick="closeMinigame()">return</button>
                </div>
            `;
            wizardSpeak(randomFrom(WIZARD_DIALOGUE.drawing), 'thinking');
        }

        function startPaintingGame() {
            document.getElementById('minigame-title').textContent = 'The Chroma Alchemist';
            document.getElementById('minigame-content').innerHTML = `
                <div class="score-display">
                    <h3>Coming Soon</h3>
                    <p class="score-label">Mix colors in mid-air in The Chroma Alchemist.</p>
                    <button class="score-btn" onclick="closeMinigame()">return</button>
                </div>
            `;
            wizardSpeak(randomFrom(WIZARD_DIALOGUE.painting), 'thinking');
        }

        function startWoodworkingGame() {
            document.getElementById('minigame-title').textContent = 'Grain & Gauge';
            document.getElementById('minigame-content').innerHTML = `
                <div class="score-display">
                    <h3>Coming Soon</h3>
                    <p class="score-label">Shape wood with precision in Grain & Gauge.</p>
                    <button class="score-btn" onclick="closeMinigame()">return</button>
                </div>
            `;
            wizardSpeak(randomFrom(WIZARD_DIALOGUE.woodworking), 'thinking');
        }

        // ============================================
        // SCORE & HUD
        // ============================================
        function showScore(score, project) {
            const content = document.getElementById('minigame-content');
            content.innerHTML = `
                <div class="score-display">
                    <h3>Project Complete</h3>
                    <div class="score-value">${score}</div>
                    <div class="score-label">creative points</div>
                    <button class="score-btn" onclick="closeMinigame()">continue</button>
                </div>
            `;
        }

        function updateHUD() {
            document.getElementById('projects-count').textContent = game.projectsCompleted;
            document.getElementById('energy-display').textContent = game.energy + '%';
        }

        // ============================================
        // UTILITIES
        // ============================================
        function randomFrom(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function createDustParticles() {
            const container = document.getElementById('game-container');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'dust-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                container.appendChild(particle);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            initWizard();
            createDustParticles();

            // Start music
            const music = document.getElementById('music');
            music.volume = 0.3;

            // Try to autoplay, otherwise wait for interaction
            document.addEventListener('click', () => {
                if (music.paused) {
                    music.play().catch(() => {});
                }
            }, { once: true });

            // Initial wizard greeting
            setTimeout(() => {
                wizardSpeak(randomFrom(WIZARD_DIALOGUE.greeting), 'calm');
            }, 1000);
        }

        init();
    </script>
</body>
</html>
